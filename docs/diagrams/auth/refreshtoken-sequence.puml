@startuml refresh-token-sequence
title Flujo de Refresh Token - SAGIM API

actor Cliente
participant "Angular (Frontend)" as FE
participant "NestJS API" as BE
participant "AuthService" as Auth
participant "JWT Service" as JWT
participant "bcrypt" as Bcrypt
database "MongoDB" as DB

Cliente -> FE : App detecta accessToken expirado
FE -> BE : POST /api/v1/auth/refresh (refreshToken)
BE -> Auth : refresh(refreshToken)

Auth -> JWT : verify(refreshToken, JWT_REFRESH_SECRET)
JWT --> Auth : válido / inválido

alt Refresh token inválido (firma)
  Auth --> BE : Error 401 (Token inválido)
  BE --> FE : 401 Unauthorized
  FE --> Cliente : Re-login requerido
else Refresh token válido
  Auth -> JWT : decode(refreshToken)
  JWT --> Auth : payload { sub, email, municipioId, rol }

  Auth -> DB : findUserById(sub)
  DB --> Auth : user | null

  alt Usuario no existe
    Auth --> BE : Error 401
    BE --> FE : 401 Unauthorized
    FE --> Cliente : Re-login requerido
  else Usuario existe
    Auth -> Auth : verificar user.refreshTokenHash existe

    alt No tiene refreshToken guardado
      Auth --> BE : Error 401 (Token inválido)
      BE --> FE : 401 Unauthorized
      FE --> Cliente : Re-login requerido
    else Tiene refreshToken
      Auth -> Bcrypt : compare(refreshToken, user.refreshTokenHash)
      Bcrypt --> Auth : match / no match

      alt No coincide con hash en BD
        Auth --> BE : Error 401 (Token inválido)
        BE --> FE : 401 Unauthorized
        FE --> Cliente : Re-login requerido
      else Coincide
        Auth -> JWT : generarNuevoAccessToken(1h)\n+ generarNuevoRefreshToken(7d)
        JWT --> Auth : newAccessToken, newRefreshToken

        Auth -> Bcrypt : hash(newRefreshToken)
        Bcrypt --> Auth : newRefreshTokenHash

        Auth -> DB : actualizar user.refreshTokenHash
        DB --> Auth : OK

        Auth --> BE : TokenResponse\n(accessToken, refreshToken, user, modulos, permisos)
        BE --> FE : 200 OK (TokenResponse)
        FE --> Cliente : Tokens renovados
      end
    end
  end
end

@enduml
